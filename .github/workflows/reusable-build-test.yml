# SPDX-License-Identifier: GPL-3.0-only
name: Reusable Build And Test

on:
  workflow_call:
    inputs:
      os:
        required: true
        type: string
      family:
        required: true
        type: string
      mode:
        required: true
        type: string
      cc:
        required: false
        default: ""
        type: string
      cxx:
        required: false
        default: ""
        type: string
      gcc-version:
        required: false
        default: ""
        type: string
      clang-version:
        required: false
        default: ""
        type: string
      windows-compiler:
        required: false
        default: ""
        type: string

permissions:
  contents: read

jobs:
  build-test:
    name: ${{ inputs.os }} / ${{ inputs.family }} / ${{ inputs.mode }}
    runs-on: ${{ inputs.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: "3.11"

      - name: Prepare Linux APT Sources
        if: runner.os == 'Linux'
        run: bash tests/ci/apt_prepare_ubuntu.sh

      - name: Setup GCC
        if: runner.os == 'Linux' && inputs.family == 'gcc'
        uses: egor-tensin/setup-gcc@eaa888eb19115a521fa72b65cd94fe1f25bbcaac
        with:
          version: ${{ inputs.gcc-version }}

      - name: Setup Clang
        if: runner.os == 'Linux' && inputs.family == 'clang'
        run: |
          sudo apt-get install -y clang-${{ inputs.clang-version }} lld-${{ inputs.clang-version }}

      - name: Setup Homebrew LLVM
        if: runner.os == 'macOS' && inputs.family == 'llvm'
        run: |
          brew update
          brew install llvm
          if [ -x /opt/homebrew/opt/llvm/bin/clang ]; then
            echo "CC_BIN=/opt/homebrew/opt/llvm/bin/clang" >> "$GITHUB_ENV"
            echo "CXX_BIN=/opt/homebrew/opt/llvm/bin/clang++" >> "$GITHUB_ENV"
          elif [ -x /usr/local/opt/llvm/bin/clang ]; then
            echo "CC_BIN=/usr/local/opt/llvm/bin/clang" >> "$GITHUB_ENV"
            echo "CXX_BIN=/usr/local/opt/llvm/bin/clang++" >> "$GITHUB_ENV"
          else
            echo "failed to locate Homebrew llvm clang" >&2
            exit 1
          fi

      - name: Setup 32-bit Toolchain Dependencies
        if: runner.os == 'Linux' && inputs.mode == 'm32'
        run: |
          sudo apt-get install -y gcc-multilib g++-multilib libc6-dev-i386

      - name: Setup MSVC Environment
        if: runner.os == 'Windows' && (inputs.family == 'msvc' || inputs.family == 'clang-cl')
        uses: ilammy/msvc-dev-cmd@0b201ec74fa43914dc39ae48a89fd1d8cb592756

      - name: Setup MSYS2
        if: runner.os == 'Windows' && inputs.family == 'mingw'
        uses: msys2/setup-msys2@4f806de0a5a7294ffabaff804b38a9b435a73bda
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-make
            mingw-w64-x86_64-python

      - name: Set Compiler Environment
        if: (runner.os != 'Windows' || inputs.family != 'mingw') && !(runner.os == 'macOS' && inputs.family == 'llvm')
        run: |
          echo "CC_BIN=${{ inputs.cc }}" >> "$GITHUB_ENV"
          echo "CXX_BIN=${{ inputs.cxx }}" >> "$GITHUB_ENV"

      - name: Check Version Consistency
        run: |
          python3 tools/check_version.py
          python3 tools/check_reserved_filenames.py

      - name: Run Unix Matrix Script
        if: runner.os != 'Windows'
        run: |
          CC_BIN="${CC_BIN}" CXX_BIN="${CXX_BIN}" bash tests/ci/run_unix_matrix.sh "${{ inputs.mode }}"

      - name: Run MinGW Matrix Script
        if: runner.os == 'Windows' && inputs.family == 'mingw'
        shell: msys2 {0}
        run: |
          CC_BIN="${{ inputs.cc }}" CXX_BIN="${{ inputs.cxx }}" bash tests/ci/run_unix_matrix.sh "${{ inputs.mode }}"

      - name: Run MSVC/Clang-CL Matrix Script
        if: runner.os == 'Windows' && (inputs.family == 'msvc' || inputs.family == 'clang-cl')
        shell: pwsh
        run: |
          ./tests/ci/run_windows_msvc.ps1 -Mode '${{ inputs.mode }}' -Compiler '${{ inputs.windows-compiler }}'
