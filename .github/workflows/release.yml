# SPDX-License-Identifier: GPL-3.0-only
name: Release

on:
  push:
    tags:
      - "v*.*.*"

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  verify-version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0
      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: "3.11"
      - name: Validate Tag And Metadata Versions
        run: |
          python3 tools/check_version.py "${GITHUB_REF_NAME}"
          python3 tools/check_reserved_filenames.py

  build-test:
    name: ${{ matrix.os }} / ${{ matrix.family }} / ${{ matrix.mode }}
    needs: verify-version
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            family: gcc
            mode: default
            cc: gcc-13
            cxx: g++-13
            gcc-version: "13"
          - os: ubuntu-latest
            family: gcc
            mode: limb64
            cc: gcc-13
            cxx: g++-13
            gcc-version: "13"
          - os: ubuntu-latest
            family: gcc
            mode: noexceptions
            cc: gcc-13
            cxx: g++-13
            gcc-version: "13"
          - os: ubuntu-latest
            family: gcc
            mode: extended-stress
            cc: gcc-13
            cxx: g++-13
            gcc-version: "13"
          - os: ubuntu-latest
            family: gcc
            mode: asan-ubsan
            cc: gcc-13
            cxx: g++-13
            gcc-version: "13"
          - os: ubuntu-latest
            family: gcc
            mode: lsan
            cc: gcc-13
            cxx: g++-13
            gcc-version: "13"
          - os: ubuntu-latest
            family: gcc
            mode: m32
            cc: gcc-13
            cxx: g++-13
            gcc-version: "13"

          - os: ubuntu-latest
            family: gcc
            mode: default
            cc: gcc-12
            cxx: g++-12
            gcc-version: "12"
          - os: ubuntu-latest
            family: gcc
            mode: default
            cc: gcc-11
            cxx: g++-11
            gcc-version: "11"

          - os: ubuntu-latest
            family: clang
            mode: default
            cc: clang-17
            cxx: clang++-17
            clang-version: "17"
          - os: ubuntu-latest
            family: clang
            mode: limb64
            cc: clang-17
            cxx: clang++-17
            clang-version: "17"
          - os: ubuntu-latest
            family: clang
            mode: noexceptions
            cc: clang-17
            cxx: clang++-17
            clang-version: "17"
          - os: ubuntu-latest
            family: clang
            mode: extended-stress
            cc: clang-17
            cxx: clang++-17
            clang-version: "17"
          - os: ubuntu-latest
            family: clang
            mode: asan-ubsan
            cc: clang-17
            cxx: clang++-17
            clang-version: "17"
          - os: ubuntu-latest
            family: clang
            mode: tsan
            cc: clang-17
            cxx: clang++-17
            clang-version: "17"
          - os: ubuntu-latest
            family: clang
            mode: m32
            cc: clang-17
            cxx: clang++-17
            clang-version: "17"

          - os: ubuntu-latest
            family: clang
            mode: default
            cc: clang-16
            cxx: clang++-16
            clang-version: "16"
          - os: ubuntu-latest
            family: clang
            mode: default
            cc: clang-18
            cxx: clang++-18
            clang-version: "18"

          - os: macos-latest
            family: appleclang
            mode: default
            cc: clang
            cxx: clang++
          - os: macos-latest
            family: appleclang
            mode: limb64
            cc: clang
            cxx: clang++
          - os: macos-latest
            family: appleclang
            mode: noexceptions
            cc: clang
            cxx: clang++

          - os: macos-latest
            family: llvm
            mode: default
            cc: clang
            cxx: clang++
          - os: macos-latest
            family: llvm
            mode: limb64
            cc: clang
            cxx: clang++
          - os: macos-latest
            family: llvm
            mode: noexceptions
            cc: clang
            cxx: clang++

          - os: windows-latest
            family: msvc
            mode: default
            windows-compiler: cl
          - os: windows-latest
            family: msvc
            mode: noexceptions
            windows-compiler: cl

          - os: windows-latest
            family: clang-cl
            mode: default
            windows-compiler: clang-cl
          - os: windows-latest
            family: clang-cl
            mode: noexceptions
            windows-compiler: clang-cl

          - os: windows-latest
            family: mingw
            mode: default
            cc: gcc
            cxx: g++
          - os: windows-latest
            family: mingw
            mode: limb64
            cc: gcc
            cxx: g++
          - os: windows-latest
            family: mingw
            mode: noexceptions
            cc: gcc
            cxx: g++

    uses: ./.github/workflows/reusable-build-test.yml
    with:
      os: ${{ matrix.os }}
      family: ${{ matrix.family }}
      mode: ${{ matrix.mode }}
      cc: ${{ matrix.cc }}
      cxx: ${{ matrix.cxx }}
      gcc-version: ${{ matrix.gcc-version }}
      clang-version: ${{ matrix.clang-version }}
      windows-compiler: ${{ matrix.windows-compiler }}

  musl-alpine:
    name: linux-musl / gcc / default
    needs: verify-version
    runs-on: ubuntu-latest
    container:
      image: alpine:3.21
    steps:
      - name: Install Dependencies
        run: apk add --no-cache bash build-base git python3
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - name: Run Musl Matrix Script
        run: |
          CC_BIN=cc CXX_BIN=c++ bash tests/ci/run_unix_matrix.sh default

  big-endian-s390x:
    name: linux-s390x / gcc / default
    needs: verify-version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - name: Run Big Endian Emulation
        uses: uraimo/run-on-arch-action@ac33288c3728ca72563c97b8b88dda5a65a84448
        with:
          arch: s390x
          distro: alpine_latest
          githubToken: ${{ github.token }}
          install: |
            apk add --no-cache bash build-base git python3
          run: |
            CC_BIN=cc CXX_BIN=c++ bash tests/ci/run_unix_matrix.sh default

  packaging-smoke:
    name: packaging-smoke / ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    needs: verify-version
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            conan: true
            vcpkg: true
          - os: macos-latest
            conan: true
            vcpkg: false
          - os: windows-latest
            conan: false
            vcpkg: false
            windows-msys: true

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: "3.11"

      - name: Setup MSYS2
        if: matrix.windows-msys == true
        uses: msys2/setup-msys2@4f806de0a5a7294ffabaff804b38a9b435a73bda
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-pkgconf
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-python
            git
            bash

      - name: Prepare Linux APT Sources
        if: runner.os == 'Linux'
        run: bash tests/ci/apt_prepare_ubuntu.sh

      - name: Install Linux Tooling
        if: runner.os == 'Linux'
        run: |
          sudo apt-get install -y pkg-config ninja-build
          python3 -m pip install --upgrade pip

      - name: Install macOS Tooling
        if: runner.os == 'macOS'
        run: |
          brew install pkg-config ninja
          python3 -m pip install --upgrade pip

      - name: Install Conan
        if: matrix.conan == true
        run: |
          python3 -m pip install conan

      - name: Cache Conan
        if: matrix.conan == true
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830
        with:
          path: ~/.conan2
          key: conan-${{ runner.os }}-${{ hashFiles('conanfile.py', 'LIMITLESS_VERSION.txt', 'VERSION') }}

      - name: Cache vcpkg
        if: matrix.vcpkg == true
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830
        with:
          path: |
            ~/.cache/vcpkg/archives
            ~/vcpkg/downloads
          key: vcpkg-${{ runner.os }}-${{ hashFiles('packaging/vcpkg/ports/limitless/**', 'CMakeLists.txt', 'limitless.h', 'limitless.hpp', 'LIMITLESS_VERSION.txt', 'VERSION') }}

      - name: Setup vcpkg
        if: matrix.vcpkg == true
        run: |
          rm -rf "$HOME/vcpkg"
          git clone --depth 1 https://github.com/microsoft/vcpkg "$HOME/vcpkg"
          "$HOME/vcpkg/bootstrap-vcpkg.sh" -disableMetrics
          mkdir -p "$HOME/.cache/vcpkg/archives"
          echo "VCPKG_ROOT=$HOME/vcpkg" >> "$GITHUB_ENV"
          echo "VCPKG_DEFAULT_BINARY_CACHE=$HOME/.cache/vcpkg/archives" >> "$GITHUB_ENV"

      - name: Packaging Smoke Test (Unix)
        if: matrix.windows-msys != true
        run: bash tests/ci/packaging_smoke.sh

      - name: Packaging Smoke Test (Windows MSYS2)
        if: matrix.windows-msys == true
        shell: msys2 {0}
        run: |
          CC_BIN=gcc CXX_BIN=g++ bash tests/ci/packaging_smoke.sh

  assemble-release:
    runs-on: ubuntu-latest
    needs:
      - build-test
      - musl-alpine
      - big-endian-s390x
      - packaging-smoke

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: "3.11"

      - name: Prepare Linux APT Sources
        run: bash tests/ci/apt_prepare_ubuntu.sh

      - name: Install Verify Tooling
        run: |
          sudo apt-get install -y pkg-config

      - name: Validate Versions Again
        run: |
          python3 tools/check_version.py "${GITHUB_REF_NAME}"
          python3 tools/check_reserved_filenames.py

      - name: Build Release Artifacts
        run: |
          set -euo pipefail
          if [[ -f LIMITLESS_VERSION.txt ]]; then
            VERSION="$(tr -d '[:space:]' < LIMITLESS_VERSION.txt)"
          elif [[ -f VERSION ]]; then
            VERSION="$(tr -d '[:space:]' < VERSION)"
          else
            echo "missing LIMITLESS_VERSION.txt (legacy fallback: VERSION)" >&2
            exit 1
          fi
          echo "LIMITLESS_VERSION=${VERSION}" >> "$GITHUB_ENV"
          mkdir -p dist

          git archive --format=tar.gz --prefix="limitless-${VERSION}/" -o "dist/limitless-${VERSION}.tar.gz" HEAD
          git archive --format=zip --prefix="limitless-${VERSION}/" -o "dist/limitless-${VERSION}.zip" HEAD

          cmake -S . -B build/release-install -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX="$PWD/build/release-install/root"
          cmake --install build/release-install
          tar -C build/release-install/root -czf "dist/limitless-${VERSION}-install.tar.gz" .

          python3 tools/generate_spdx_sbom.py --root . --name limitless --version "$VERSION" --out "dist/limitless-${VERSION}.spdx.json"
          (cd dist && sha256sum -- ./* > SHA256SUMS)
          python3 tools/extract_changelog.py "${GITHUB_REF_NAME}" > dist/RELEASE_NOTES.md

      - name: Verify Release Artifacts
        run: bash tests/ci/verify_release_artifacts.sh dist "${LIMITLESS_VERSION}"

      - name: Upload Release Artifacts (workflow)
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: release-assets
          path: dist/*

      - name: Attest Build Provenance
        uses: actions/attest-build-provenance@96b4a1ef7235a096b17240c259729fdd70c83d45
        with:
          subject-path: |
            dist/limitless-*.tar.gz
            dist/limitless-*.zip
            dist/limitless-*.spdx.json
            dist/SHA256SUMS

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b
        with:
          body_path: dist/RELEASE_NOTES.md
          prerelease: ${{ contains(github.ref_name, '-rc') || contains(github.ref_name, '-beta') }}
          files: |
            dist/limitless-*.tar.gz
            dist/limitless-*.zip
            dist/limitless-*.spdx.json
            dist/SHA256SUMS
