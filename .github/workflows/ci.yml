# SPDX-License-Identifier: GPL-3.0-only
name: CI

on:
  push:
    branches: ["**"]
  pull_request:
  workflow_dispatch:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  build-test:
    name: ${{ matrix.os }} / ${{ matrix.family }} / ${{ matrix.mode }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            family: gcc
            mode: default
            cc: gcc-13
            cxx: g++-13
            gcc-version: "13"
          - os: ubuntu-latest
            family: gcc
            mode: limb64
            cc: gcc-13
            cxx: g++-13
            gcc-version: "13"
          - os: ubuntu-latest
            family: gcc
            mode: noexceptions
            cc: gcc-13
            cxx: g++-13
            gcc-version: "13"
          - os: ubuntu-latest
            family: gcc
            mode: extended-stress
            cc: gcc-13
            cxx: g++-13
            gcc-version: "13"
          - os: ubuntu-latest
            family: gcc
            mode: asan-ubsan
            cc: gcc-13
            cxx: g++-13
            gcc-version: "13"
          - os: ubuntu-latest
            family: gcc
            mode: lsan
            cc: gcc-13
            cxx: g++-13
            gcc-version: "13"
          - os: ubuntu-latest
            family: gcc
            mode: m32
            cc: gcc-13
            cxx: g++-13
            gcc-version: "13"

          - os: ubuntu-latest
            family: gcc
            mode: default
            cc: gcc-12
            cxx: g++-12
            gcc-version: "12"
          - os: ubuntu-latest
            family: gcc
            mode: default
            cc: gcc-11
            cxx: g++-11
            gcc-version: "11"

          - os: ubuntu-latest
            family: clang
            mode: default
            cc: clang-17
            cxx: clang++-17
            clang-version: "17"
          - os: ubuntu-latest
            family: clang
            mode: limb64
            cc: clang-17
            cxx: clang++-17
            clang-version: "17"
          - os: ubuntu-latest
            family: clang
            mode: noexceptions
            cc: clang-17
            cxx: clang++-17
            clang-version: "17"
          - os: ubuntu-latest
            family: clang
            mode: extended-stress
            cc: clang-17
            cxx: clang++-17
            clang-version: "17"
          - os: ubuntu-latest
            family: clang
            mode: asan-ubsan
            cc: clang-17
            cxx: clang++-17
            clang-version: "17"
          - os: ubuntu-latest
            family: clang
            mode: tsan
            cc: clang-17
            cxx: clang++-17
            clang-version: "17"
          - os: ubuntu-latest
            family: clang
            mode: m32
            cc: clang-17
            cxx: clang++-17
            clang-version: "17"

          - os: ubuntu-latest
            family: clang
            mode: default
            cc: clang-16
            cxx: clang++-16
            clang-version: "16"
          - os: ubuntu-latest
            family: clang
            mode: default
            cc: clang-18
            cxx: clang++-18
            clang-version: "18"

          - os: macos-latest
            family: appleclang
            mode: default
            cc: clang
            cxx: clang++
          - os: macos-latest
            family: appleclang
            mode: limb64
            cc: clang
            cxx: clang++
          - os: macos-latest
            family: appleclang
            mode: noexceptions
            cc: clang
            cxx: clang++

          - os: macos-latest
            family: llvm
            mode: default
            cc: clang
            cxx: clang++
          - os: macos-latest
            family: llvm
            mode: limb64
            cc: clang
            cxx: clang++
          - os: macos-latest
            family: llvm
            mode: noexceptions
            cc: clang
            cxx: clang++

          - os: windows-latest
            family: msvc
            mode: default
            windows-compiler: cl
          - os: windows-latest
            family: msvc
            mode: noexceptions
            windows-compiler: cl

          - os: windows-latest
            family: clang-cl
            mode: default
            windows-compiler: clang-cl
          - os: windows-latest
            family: clang-cl
            mode: noexceptions
            windows-compiler: clang-cl

          - os: windows-latest
            family: mingw
            mode: default
            cc: gcc
            cxx: g++
          - os: windows-latest
            family: mingw
            mode: limb64
            cc: gcc
            cxx: g++
          - os: windows-latest
            family: mingw
            mode: noexceptions
            cc: gcc
            cxx: g++

    uses: ./.github/workflows/reusable-build-test.yml
    with:
      os: ${{ matrix.os }}
      family: ${{ matrix.family }}
      mode: ${{ matrix.mode }}
      cc: ${{ matrix.cc }}
      cxx: ${{ matrix.cxx }}
      gcc-version: ${{ matrix.gcc-version }}
      clang-version: ${{ matrix.clang-version }}
      windows-compiler: ${{ matrix.windows-compiler }}

  musl-alpine:
    name: linux-musl / gcc / default
    runs-on: ubuntu-latest
    container:
      image: alpine:3.21
    steps:
      - name: Install Dependencies
        run: apk add --no-cache bash build-base git python3
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - name: Run Musl Matrix Script
        run: |
          CC_BIN=cc CXX_BIN=c++ bash tests/ci/run_unix_matrix.sh default

  big-endian-s390x:
    name: linux-s390x / gcc / default
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - name: Run Big Endian Emulation
        uses: uraimo/run-on-arch-action@ac33288c3728ca72563c97b8b88dda5a65a84448
        with:
          arch: s390x
          distro: alpine_latest
          githubToken: ${{ github.token }}
          install: |
            apk add --no-cache bash build-base git python3
          run: |
            CC_BIN=cc CXX_BIN=c++ bash tests/ci/run_unix_matrix.sh default

  packaging-smoke:
    name: packaging-smoke / ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            conan: true
            vcpkg: true
          - os: macos-latest
            conan: true
            vcpkg: false
          - os: windows-latest
            conan: false
            vcpkg: false
            windows-msys: true

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: "3.11"

      - name: Setup MSYS2
        if: matrix.windows-msys == true
        uses: msys2/setup-msys2@4f806de0a5a7294ffabaff804b38a9b435a73bda
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-pkgconf
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-python
            git
            bash

      - name: Prepare Linux APT Sources
        if: runner.os == 'Linux'
        run: bash tests/ci/apt_prepare_ubuntu.sh

      - name: Install Linux Tooling
        if: runner.os == 'Linux'
        run: |
          sudo apt-get install -y pkg-config ninja-build
          python3 -m pip install --upgrade pip

      - name: Install macOS Tooling
        if: runner.os == 'macOS'
        run: |
          brew install pkg-config ninja
          python3 -m pip install --upgrade pip

      - name: Install Conan
        if: matrix.conan == true
        run: |
          python3 -m pip install conan

      - name: Cache Conan
        if: matrix.conan == true
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830
        with:
          path: ~/.conan2
          key: conan-${{ runner.os }}-${{ hashFiles('conanfile.py', 'LIMITLESS_VERSION.txt', 'VERSION') }}

      - name: Cache vcpkg
        if: matrix.vcpkg == true
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830
        with:
          path: |
            ~/.cache/vcpkg/archives
            ~/vcpkg/downloads
          key: vcpkg-${{ runner.os }}-${{ hashFiles('packaging/vcpkg/ports/limitless/**', 'CMakeLists.txt', 'limitless.h', 'limitless.hpp', 'LIMITLESS_VERSION.txt', 'VERSION') }}

      - name: Setup vcpkg
        if: matrix.vcpkg == true
        run: |
          rm -rf "$HOME/vcpkg"
          git clone --depth 1 https://github.com/microsoft/vcpkg "$HOME/vcpkg"
          "$HOME/vcpkg/bootstrap-vcpkg.sh" -disableMetrics
          mkdir -p "$HOME/.cache/vcpkg/archives"
          echo "VCPKG_ROOT=$HOME/vcpkg" >> "$GITHUB_ENV"
          echo "VCPKG_DEFAULT_BINARY_CACHE=$HOME/.cache/vcpkg/archives" >> "$GITHUB_ENV"

      - name: Packaging Smoke Test (Unix)
        if: matrix.windows-msys != true
        run: bash tests/ci/packaging_smoke.sh

      - name: Packaging Smoke Test (Windows MSYS2)
        if: matrix.windows-msys == true
        shell: msys2 {0}
        run: |
          CC_BIN=gcc CXX_BIN=g++ bash tests/ci/packaging_smoke.sh

  benchmark-regression:
    name: benchmark-regression
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - name: Prepare Linux APT Sources
        run: bash tests/ci/apt_prepare_ubuntu.sh
      - name: Install GCC
        run: |
          sudo apt-get install -y gcc
      - name: Run Benchmark Regression
        run: |
          CC_BIN=gcc bash tests/ci/run_bench_regression.sh

  packaging-gate:
    name: packaging-gate
    runs-on: ubuntu-latest
    needs: [packaging-smoke]
    if: always()
    steps:
      - name: Evaluate Packaging Gate
        env:
          PACKAGING_RESULT: ${{ needs.packaging-smoke.result }}
        run: |
          [[ "$PACKAGING_RESULT" == "success" ]]

  ci-gate:
    name: ci-gate
    runs-on: ubuntu-latest
    needs:
      - build-test
      - musl-alpine
      - big-endian-s390x
      - packaging-gate
      - benchmark-regression
    if: always()
    steps:
      - name: Evaluate CI Gate
        env:
          BUILD_TEST_RESULT: ${{ needs.build-test.result }}
          MUSL_RESULT: ${{ needs.musl-alpine.result }}
          S390X_RESULT: ${{ needs.big-endian-s390x.result }}
          PACKAGING_RESULT: ${{ needs.packaging-gate.result }}
          BENCHMARK_RESULT: ${{ needs.benchmark-regression.result }}
        run: |
          [[ "$BUILD_TEST_RESULT" == "success" ]]
          [[ "$MUSL_RESULT" == "success" ]]
          [[ "$S390X_RESULT" == "success" ]]
          [[ "$PACKAGING_RESULT" == "success" ]]
          [[ "$BENCHMARK_RESULT" == "success" ]]
